@using System.Linq
@using Forge.CLI.Core.Templates
@using Forge.CLI.Shared.Extensions
@using static Forge.CLI.Shared.Helpers.ForgeHelper
@model TemplateModel
@{
    var projectName = Model.Project.Name;

    var referencedNamespaces = new List<string>()
    {
		UsingInCSharp("Microsoft.AspNetCore.Builder"),
		UsingInCSharp("Microsoft.EntityFrameworkCore"),
		UsingInCSharp("Microsoft.EntityFrameworkCore.Storage"),
		UsingInCSharp("Microsoft.Extensions.Configuration"),
		UsingInCSharp("Microsoft.Extensions.DependencyInjection"),
		UsingInCSharp("System"),
		UsingInCSharp("System.Collections.Generic"),
		UsingInCSharp("System.Linq"),
    };
    foreach(var c in Model.Project.Contexts)
    {
		referencedNamespaces.Add(UsingInCSharp($"{RenderArtifactNamespace("Infrastructure.DbContext", Model, targetContext: c.Key)}"));
		referencedNamespaces.Add(UsingInCSharp($"{RenderArtifactNamespace("Infrastructure.DbContextReader", Model, targetContext: c.Key)}"));
		referencedNamespaces.Add(UsingInCSharp($"{RenderArtifactNamespace("Infrastructure.DbContextWriter", Model, targetContext: c.Key)}"));
		referencedNamespaces.Add(UsingInCSharp($"{RenderArtifactNamespace("Domain.IDbContextReader", Model, targetContext: c.Key)}"));
		referencedNamespaces.Add(UsingInCSharp($"{RenderArtifactNamespace("Domain.IDbContextWriter", Model, targetContext: c.Key)}"));
    }
}

@foreach (var referencedNamespace in referencedNamespaces.Order().Distinct())
{
<text>@(referencedNamespace)
</text>
}

namespace @(Model.Namespace)
{
	public static class AddDbContextConfigurations
	{
		public static IServiceCollection AddDbContexts(this IServiceCollection services, IConfiguration configuration)
		{
@foreach(var context in Model.Project.Contexts)
{
<text>@(Tab(3))#region Reader/Writer, @(context.Key)DbContext and Connection
@(Tab(3))var @(context.Key.ToCamel())ConnectionString = configuration.GetConnectionString("@(context.Key)Connection");

@(Tab(3))services.AddTransient<I@(context.Key)DbContextWriter, @(context.Key)DbContextWriter>();
@(Tab(3))services.AddTransient<I@(context.Key)DbContextReader, @(context.Key)DbContextReader>();

@(Tab(3))services.AddDbContext<@(context.Key)DbContext>(options =>
@(Tab(4))options.UseSqlServer(
@(Tab(5))@(context.Key.ToCamel())ConnectionString,
@(Tab(5))sql =>
@(Tab(5)){
@(Tab(6))sql.MigrationsAssembly(typeof(@(context.Key)DbContext).Assembly.GetName().Name);
@(Tab(6))sql.MigrationsHistoryTable("__EFMigrationsHistory", @(context.Key)DbContext.Schema);
@(Tab(6))sql.EnableRetryOnFailure(5, TimeSpan.FromSeconds(10), null);
@(Tab(5))}));
@(Tab(3))#endregion
</text>
}
			return services;
		}
		public static IServiceCollection AddDbContextsTest(this IServiceCollection services, IConfiguration configuration)
		{
@foreach(var context in Model.Project.Contexts)
{
<text>@(Tab(3))#region Reader/Writer, @(context.Key)DbContext and InMemory
@(Tab(3))services.AddTransient<I@(context.Key)DbContextWriter, @(context.Key)DbContextWriter>();
@(Tab(3))services.AddTransient<I@(context.Key)DbContextReader, @(context.Key)DbContextReader>();

@(Tab(3))services.AddDbContext<@(context.Key)DbContext>(options =>
@(Tab(4))options.UseInMemoryDatabase(nameof(@(context.Key)DbContext), new InMemoryDatabaseRoot()),
@(Tab(4))ServiceLifetime.Singleton);
@(Tab(3))#endregion

</text>
}

			return services;
		}

		public static IApplicationBuilder UseMigrations(this IApplicationBuilder app)
		{
			using (var scope = app.ApplicationServices.CreateScope())
			{
@foreach (var context in Model.Project.Contexts)
{
<text>@(Tab(4))#region @(context.Key)DbContext migrate
@(Tab(4))var @(context.Key.ToCamel())DbContext = scope.ServiceProvider.GetRequiredService<@(context.Key)DbContext>();
@(Tab(4))if (@(context.Key.ToCamel())DbContext.Database.IsRelational())
@(Tab(5))@(context.Key.ToCamel())DbContext.Database.Migrate();
@(Tab(4))#endregion
</text>
}
			}

			return app;
		}
	}
}