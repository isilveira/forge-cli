@using System.Linq
@using Forge.CLI.Core.Templates
@using Forge.CLI.Shared.Extensions
@using static Forge.CLI.Shared.Helpers.ForgeHelper
@using System.Net
@using Forge.CLI.Shared.Helpers
@model TemplateModel
@{
	var projectName = Model.Project.Name;
	var contextName = Model.ContextName;
	var entityName = Model.EntityName;
	var entityCollection = Pluralize(Model.EntityName);

	var queryRelationsManyToOne = Model.Entity.Relations.Where(r => r.Value.Type == "many-to-one").AsQueryable();
	var queryRelationsOneToMany = Model.Entity.Relations.Where(r => r.Value.Type == "one-to-many").AsQueryable();

    var referencedNamespaces = new List<string>()
    {
        UsingInCSharp("System"),
        UsingInCSharp("System.Collections.Generic"),
        UsingInCSharp("BAYSOFT.Abstractions.Core.Domain.Entities"),
        UsingInCSharp("BAYSOFT.Abstractions.Crosscutting.InheritStringLocalization"),
        UsingInCSharp($"{RenderArtifactNamespace("Domain.EntityResource.Designer", Model)}"),
        UsingInCSharp($"{RenderArtifactNamespace("Domain.ContextResource.Designer", Model)}"),
        UsingInCSharp($"{RenderArtifactNamespace("Domain.Resource.Designer", Model)}"),
    };
    foreach (var relation in Model.Entity.Relations)
    {
        referencedNamespaces.Add(UsingInCSharp($"{RenderArtifactNamespace("Domain.Entity", Model, targetEntity: relation.Value.Target)}"));
	}
}
@foreach (var referencedNamespace in referencedNamespaces.Order().Distinct())
{
<text>@(referencedNamespace)
</text>
}

namespace @(Model.Namespace)
{
    // <forge:entity context="@(contextName)" name="@(entityName)" id-type="@(TypeMapperHelper.Map(Model.Entity.IdType))" table="@(Model.Entity.Table)" aggregateRoot="@(Model.Entity.AggregateRoot.ToString().ToLower())" auditable="@(Model.Entity.Auditable.ToString().ToLower())">
    [InheritStringLocalizer(typeof(Messages), Priority = 2)]
    [InheritStringLocalizer(typeof(Context@(contextName)), Priority = 1)]
    [InheritStringLocalizer(typeof(Entity@(entityName)), Priority = 0)]
    public @(Model.Project.UseSealedClasses ? "sealed ":"")class @entityName : DomainEntity<@(TypeMapperHelper.Map(Model.Entity.IdType))>
    {
        #region Attributes
@if (Model.Entity.Properties.Any())
{
    foreach (var prop in Model.Entity.Properties.Where(p => p.Key != "Id"))
    {
<text>        // <forge:property entity="@(entityName)" name="@(prop.Key)" type="@(prop.Value.Type)"@if(prop.Value.Required){<text> required="true"</text>}@if (prop.Value.Length.HasValue){<text> length="@(prop.Value.Length)"</text>}@if (prop.Value.HasMaxLength){<text> has-max-length="true"</text>}@if (prop.Value.Precision.HasValue){<text> precision="@(prop.Value.Precision)"</text>}@if (prop.Value.Scale.HasValue){<text> scale="@(prop.Value.Scale)"</text>} db-column="@(prop.Value.DbColumn)"@if(prop.Value.DisplayOnSelect){<text> display-on-select="true"</text>}>
        public @TypeMapperHelper.Map(prop.Value.Type)@(prop.Value.Required ? "" : "?") @prop.Key { get; set; }
</text>
    }
}
else
{
<text>        // No properties defined
</text>
}
        #endregion

        #region Foreign keys
@if (queryRelationsManyToOne.Any())
{
    foreach(var relation in queryRelationsManyToOne.ToList())
    {
<text>        public @(relation.Value.GetTargetIdType())@(relation.Value.Required ? "" : "?") @(relation.Key)Id { get; set; }
</text>
    }
}
else
{
<text>        // No foreign keys defined
</text>
}
        #endregion

        #region Navigation properties
@if (queryRelationsManyToOne.Any() || queryRelationsOneToMany.Any())
{
    if (queryRelationsManyToOne.Any())
    {
        foreach (var relation in queryRelationsManyToOne.ToList())
        {
<text>        // <forge:relationship from="@(entityName)" to="@(relation.Value.Target)" kind="many-to-one"@if(relation.Value.Required){<text> required="true"</text>}>
        public @(relation.Value.Target) @(relation.Key) { get; set; }
</text>
        }
    }
    if (queryRelationsOneToMany.Any())
    {
        foreach (var relation in queryRelationsOneToMany.ToList())
        {
<text>        // <forge:relationship from="@(entityName)" to="@(relation.Value.Target)" kind="one-to-many" @if(relation.Value.Required){<text> required="true"</text>}>
        public @(Model.Project.UseVirtualCollections ? "virtual ":"")ICollection<@(relation.Value.Target)> @(relation.Key) { get; set; }
</text>
        }
    }
}
else
{
<text>        // No navigation properties defined
</text>
}
        #endregion

        #region Constructors
        public @(Model.EntityName)()
        {
            InitializeCollections();
        }
        #endregion

        #region Methods
        public void InitializeCollections()
        {
@if (queryRelationsOneToMany.Any())
{
    foreach (var relation in queryRelationsOneToMany.ToList())
    {
<text>            @(relation.Key) = new HashSet<@(relation.Value.Target)>();
</text>
    }
}
else
{
<text>            // Initialize collections here
</text>
}
        }
	    // Add domain methods here
        #endregion
    }
}