@using System.Linq
@using Forge.CLI.Core.Templates
@using Forge.CLI.Shared.Extensions
@using static Forge.CLI.Shared.Helpers.ForgeHelper
@model TemplateModel
@{
    var projectName = Model.Project.Name;
    var contextName = Model.ContextName;
    var entityName = Model.EntityName;
    var entityCollection = Pluralize(entityName);

    var name = Model.Name;

    var queryRelationsManyToOne = Model.Entity.Relations.Where(r => r.Value.Type == "many-to-one").AsQueryable();
    var queryRelationsOneToMany = Model.Entity.Relations.Where(r => r.Value.Type == "one-to-many").AsQueryable();

    var referencedNamespaces = new List<string>()
    {
        UsingInCSharp("BAYSOFT.Abstractions.Core.Domain.Entities.Specifications"),
        UsingInCSharp("System"),
        UsingInCSharp("System.Linq"),
        UsingInCSharp("System.Linq.Expressions"),
        UsingInCSharp($"{RenderArtifactNamespace("Domain.Entity", Model)}"),
        UsingInCSharp($"{RenderArtifactNamespace("Domain.IDbContextReader", Model)}"),
    };
}
@foreach (var referencedNamespace in referencedNamespaces.Order().Distinct())
{
<text>@(referencedNamespace)
</text>
}

namespace @(Model.Namespace)
{
    public @(Model.Project.UseSealedClasses ? "sealed ":"")class @(entityName)@(name)Specification : DomainSpecification<@(entityName)>
    {
        private I@(contextName)DbContextReader Reader { get; set; }
        public @(entityName)@(name)Specification(I@(contextName)DbContextReader reader)
        {
            Reader = reader;
            SpecificationMessage = "J� existe um registro com essa descri��o!";
        }

        public override Expression<Func<@(entityName), bool>> ToExpression()
        {
            return entity => CheckRule(entity);
        }

        private bool CheckRule(@(entityName) entity)
        {
            // if CheckRule true show message, unless the specification has ".Not()"
            return Reader.Query<@(entityName)>().Any(x => x.Description == entity.Description && x.Id != entity.Id);
        }
    }
}
