@using System.Linq
@using Forge.CLI.Core.Templates
@using Forge.CLI.Shared.Extensions
@using static Forge.CLI.Shared.Helpers.ForgeHelper
@model TemplateModel
@{
	var projectName = Model.Project.Name;
	var contextName = Model.ContextName;
	var entityName = Model.EntityName;
	var entityCollection = Pluralize(entityName);

	var name = Model.Name;

	var queryRelationsManyToOne = Model.Entity.Relations.Where(r => r.Value.Type == "many-to-one").AsQueryable();
	var queryRelationsOneToMany = Model.Entity.Relations.Where(r => r.Value.Type == "one-to-many").AsQueryable();

	var referencedNamespaces = new List<string>()
	{
		UsingInCSharp("BAYSOFT.Abstractions.Core.Domain.Entities.Services"),
		UsingInCSharp("Microsoft.Extensions.Localization"),
		UsingInCSharp("System.Threading"),
		UsingInCSharp("System.Threading.Tasks"),
		UsingInCSharp($"{RenderArtifactNamespace("Domain.Entity", Model)}"),
		UsingInCSharp($"{RenderArtifactNamespace("Domain.Validation.New", Model)}"),
		UsingInCSharp($"{RenderArtifactNamespace("Domain.Validation.Entity", Model)}"),
		UsingInCSharp($"{RenderArtifactNamespace("Domain.IDbContextWriter", Model)}"),
	};
}
@foreach (var referencedNamespace in referencedNamespaces.Order().Distinct())
{
<text>@(referencedNamespace)
</text>
}

namespace @(Model.Namespace)
{
	public @(Model.Project.UseSealedClasses ? "sealed ":"")class Update@(name)@(entityName)ServiceRequest : DomainServiceRequest<@(entityName)>
	{
		public Update@(name)@(entityName)ServiceRequest(@(entityName) payload) : base(payload)
		{
		}
	}
	public @(Model.Project.UseSealedClasses ? "sealed ":"")class Update@(name)@(entityName)ServiceRequestHandler
		: DomainServiceRequestHandler<@(entityName), Update@(name)@(entityName)ServiceRequest>
	{
		private I@(contextName)DbContextWriter Writer { get; set; }
		public Update@(name)@(entityName)ServiceRequestHandler(
			I@(contextName)DbContextWriter writer,
			IStringLocalizer<@(entityName)> localizer, 
			@(entityName)Validator entityValidator,
			Update@(name)@(entityName)SpecificationsValidator domainValidator)
			: base(localizer, entityValidator, domainValidator)
		{
			Writer = writer;
		}
		public override async Task<@(entityName)> Handle(
			Update@(name)@(entityName)ServiceRequest request,
			CancellationToken cancellationToken)
		{
			ValidateEntity(request.Payload);

			ValidateDomain(request.Payload);

			// Do the update

			return request.Payload;
		}
	}
}