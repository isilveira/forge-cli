@using System.Linq
@using Forge.CLI.Core.Templates
@using Forge.CLI.Shared.Extensions
@using static Forge.CLI.Shared.Helpers.ForgeHelper
@model TemplateModel
@{
    var projectName = Model.Project.Name;
    var contextName = Model.ContextName;
    var entityName = Model.EntityName;
    var entityCollection = Pluralize(entityName);

    var queryRelationsManyToOne = Model.Entity.Relations.Where(r => r.Value.Type == "many-to-one").AsQueryable();
    var queryRelationsOneToMany = Model.Entity.Relations.Where(r => r.Value.Type == "one-to-many").AsQueryable();

    var referencedNamespaces = new List<string>()
    {
        UsingInCSharp("BAYSOFT.Abstractions.Core.Application"),
        UsingInCSharp("BAYSOFT.Abstractions.Core.Domain.Exceptions"),
        UsingInCSharp("BAYSOFT.Abstractions.Crosscutting.Helpers"),
        UsingInCSharp("FluentValidation"),
        UsingInCSharp("MediatR"),
        UsingInCSharp("Microsoft.EntityFrameworkCore"),
        UsingInCSharp("Microsoft.Extensions.Localization"),
        UsingInCSharp("Microsoft.Extensions.Logging"),
        UsingInCSharp("ModelWrapper"),
        UsingInCSharp("ModelWrapper.Extensions.Patch"),
        UsingInCSharp("System"),
        UsingInCSharp("System.Collections.Generic"),
        UsingInCSharp("System.Net"),
        UsingInCSharp("System.Threading"),
        UsingInCSharp("System.Threading.Tasks"),
        UsingInCSharp($"{RenderArtifactNamespace("Application.Notification.Patch", Model)}"),
        UsingInCSharp($"{RenderArtifactNamespace("Domain.Entity", Model)}"),
        UsingInCSharp($"{RenderArtifactNamespace("Domain.Service.Update", Model)}"),
        UsingInCSharp($"{RenderArtifactNamespace("Domain.IDbContextWriter", Model)}"),
    };
}
@foreach (var referencedNamespace in referencedNamespaces.Order().Distinct())
{
<text>@(referencedNamespace)
</text>
}

namespace @(Model.Namespace)
{
    public @(Model.Project.UseSealedClasses ? "sealed ":"")class Patch@(entityName)Command : ApplicationRequest<@(entityName), Patch@(entityName)CommandResponse>
    {
        public Patch@(entityName)Command()
        {
            ConfigKeys(x => x.Id);

            ConfigSuppressedProperties(x => x.Id);

@if (queryRelationsOneToMany.Any())
{
    foreach (var relation in queryRelationsOneToMany.ToList())
    {
<text>@(Tab(3))ConfigSuppressedResponseProperties(x => x.@(relation.Key));
</text>
    }
}
else
{
<text>@(Tab(3))// TODO: SUPPRESSED RESPONSE PROPERTIES
</text>
}

            Validator.RuleFor(x => x.Id).NotEmpty().WithMessage("{0} is required!");
        }
    }

    public @(Model.Project.UseSealedClasses ? "sealed ":"")class Patch@(entityName)CommandResponse : ApplicationResponse<@(entityName)>
    {
        public Patch@(entityName)CommandResponse(Tuple<int, int, WrapRequest<@(entityName)>, Dictionary<string, object>, Dictionary<string, object>, string, long?> tuple)
            : base(tuple)
        {
        }

        public Patch@(entityName)CommandResponse(int statusCode, WrapRequest<@(entityName)> request, object data, string message = "Successful operation!", long? resultCount = null)
            : base(statusCode, request, data, message, resultCount)
        {
        }
    }
    public @(Model.Project.UseSealedClasses ? "sealed ":"")class Patch@(entityName)CommandHandler : ApplicationRequestHandler<@(entityName), Patch@(entityName)Command, Patch@(entityName)CommandResponse>
    {
        private ILoggerFactory Logger { get; set; }
        private IMediator Mediator { get; set; }
        private IStringLocalizer Localizer { get; set; }
        private I@(contextName)DbContextWriter Writer { get; set; }
        public Patch@(entityName)CommandHandler(
            ILoggerFactory logger,
            IMediator mediator,
            IStringLocalizer<@(entityName)> localizer,
            I@(contextName)DbContextWriter writer
        )
        {
            Logger = logger;
            Mediator = mediator;
            Localizer = localizer;
            Writer = writer;
        }
        public override async Task<Patch@(entityName)CommandResponse> Handle(Patch@(entityName)Command request, CancellationToken cancellationToken)
        {
            try
            {
                request.IsValid(Localizer, true);

                var id = request.Project(x => x.Id);

                var data = await Writer
                    .Query<@(entityName)>()
                    .SingleOrDefaultAsync(x => x.Id == id);

                if (data == null)
                {
                    throw new EntityNotFoundException<@(entityName)>(Localizer);
                }

                request.Patch(data);

                await Mediator.Send(new Update@(entityName)ServiceRequest(data));

                await Writer.CommitAsync(cancellationToken);

                await Mediator.Publish(new Patch@(entityName)Notification(data));

                return new Patch@(entityName)CommandResponse((int)HttpStatusCode.OK, request, data, Localizer["Successful operation!"], 1);
            }
            catch (Exception exception)
            {
                Logger.CreateLogger<Patch@(entityName)CommandHandler>().Log(LogLevel.Error, exception, exception.Message);

                return new Patch@(entityName)CommandResponse(ExceptionResponseHelper.CreateTuple(Localizer, request, exception));
            }
        }
    }
}
