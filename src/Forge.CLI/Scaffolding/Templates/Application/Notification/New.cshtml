@using System.Linq
@using Forge.CLI.Core.Templates
@using Forge.CLI.Shared.Extensions
@using static Forge.CLI.Shared.Helpers.ForgeHelper
@model TemplateModel
@{
    var projectName = Model.Project.Name;
    var contextName = Model.ContextName;
    var entityName = Model.EntityName;
    var entityCollection = Pluralize(entityName);

    var name = Model.Name;

    var queryRelationsManyToOne = Model.Entity.Relations.Where(r => r.Value.Type == "many-to-one").AsQueryable();
    var queryRelationsOneToMany = Model.Entity.Relations.Where(r => r.Value.Type == "one-to-many").AsQueryable();

    var referencedNamespaces = new List<string>()
    {
        UsingInCSharp("MediatR"),
        UsingInCSharp("Microsoft.Extensions.Logging"),
        UsingInCSharp("Newtonsoft.Json"),
        UsingInCSharp("System"),
        UsingInCSharp("System.Collections.Generic"),
        UsingInCSharp("System.Text"),
        UsingInCSharp("System.Threading"),
        UsingInCSharp("System.Threading.Tasks"),
        UsingInCSharp($"{RenderArtifactNamespace("Domain.Entity", Model)}"),
    };
}
@foreach (var referencedNamespace in referencedNamespaces.Order().Distinct())
{
<text>@(referencedNamespace)
</text>
}

namespace @(Model.Namespace)
{
    public @(Model.Project.UseSealedClasses ? "sealed ":"")class Patch@(name)@(entityName)Notification : INotification
    {
        public @(entityName) Payload { get; set; }
        public DateTime CreatedAt { get; set; }
        public Patch@(name)@(entityName)Notification(@(entityName) payload)
        {
            Payload = payload;
            CreatedAt = DateTime.UtcNow;
        }
    }

    public @(Model.Project.UseSealedClasses ? "sealed ":"")class Patch@(name)@(entityName)NotificationHandler : INotificationHandler<Patch@(entityName)Notification>
    {
        private ILoggerFactory Logger { get; set; }
        private IMediator Mediator { get; set; }
        public Patch@(name)@(entityName)NotificationHandler(
        ILoggerFactory logger,
        IMediator mediator)
        {
            Logger = logger;
            Mediator = mediator;
        }
        public Task Handle(Patch@(name)@(entityName)Notification notification, CancellationToken cancellationToken)
        {
            Logger.CreateLogger<Patch@(entityName)NotificationHandler>()
                .Log(LogLevel.Information, $"@(entityName) patched! - Event Created At: {notification.CreatedAt:yyyy-MM-dd HH:mm:ss} Payload: {JsonConvert.SerializeObject(notification.Payload)}");

            return Task.CompletedTask;
        }
    }
}