@using System.Linq
@using BAYSOFT.Abstractions.Crosscutting.Extensions
@using Forge.CLI.Core.Templates
@using Forge.CLI.Shared.Extensions
@using Forge.CLI.Shared.Helpers
@using static Forge.CLI.Shared.Helpers.ForgeHelper
@model TemplateModel
@{
	var projectName = Model.Project.Name;
	var contextName = Model.ContextName;
	var entityName = Model.EntityName;
	var entityCollection = Pluralize(Model.EntityName);

	var projectConvention = GetProjectConvention(Model.Project);

	var entityRoute = entityCollection.ToKebabCase();

	var queryRelationsManyToOne = Model.Entity.Relations.Where(r => r.Value.Type == "many-to-one").AsQueryable();
	var queryRelationsOneToMany = Model.Entity.Relations.Where(r => r.Value.Type == "one-to-many").AsQueryable();

    var referencedNamespaces = new List<string>()
    {
		UsingInCSharp($"{RenderArtifactNamespace("Application.Command.Post", Model)}"),
		UsingInCSharp($"{RenderArtifactNamespace("Application.Command.Put", Model)}"),
		UsingInCSharp($"{RenderArtifactNamespace("Application.Command.Patch", Model)}"),
		UsingInCSharp($"{RenderArtifactNamespace("Application.Command.Delete", Model)}"),
		UsingInCSharp($"{RenderArtifactNamespace("Application.Command.New", Model)}"),
		UsingInCSharp($"{RenderArtifactNamespace("Application.Query.GetByFilter", Model)}"),
		UsingInCSharp($"{RenderArtifactNamespace("Application.Query.GetById", Model)}"),
		UsingInCSharp($"{RenderArtifactNamespace("Application.Query.New", Model)}"),
		UsingInCSharp($"{RenderArtifactNamespace("Application.Query.New", Model)}"),
		UsingInCSharp($"{projectConvention}.Presentations.Web.Api.Abstractions.Controllers"),
		UsingInCSharp("Microsoft.AspNetCore.Mvc"),
		UsingInCSharp("System"),
		UsingInCSharp("System.Threading"),
		UsingInCSharp("System.Threading.Tasks"),
    };
    foreach (var relation in Model.Entity.Relations)
    {
		referencedNamespaces.Add(UsingInCSharp($"{RenderArtifactNamespace("Domain.Entity", Model, targetEntity: relation.Value.Target)}"));
	}
}
@foreach (var referencedNamespace in referencedNamespaces.Order().Distinct())
{
<text>@(referencedNamespace)
</text>
}

namespace @(Model.Namespace)
{
    [Produces("application/json")]
    [Route("api/@(contextName.ToKebabCase())/@(entityRoute)")]
    public @(Model.Project.UseSealedClasses ? "sealed ":"")class @(entityCollection)Controller : ResourceController
    {
		[HttpGet]
		public async Task<ActionResult<Get@(entityCollection)ByFilterQueryResponse>> Get(Get@(entityCollection)ByFilterQuery request, CancellationToken cancellationToken = default(CancellationToken))
		{
			return await Send(request, cancellationToken);
		}

		[HttpGet("{id:@(TypeMapperHelper.Map(Model.Entity.IdType))}")]
		public async Task<ActionResult<Get@(entityName)ByIdQueryResponse>> Get(Get@(entityName)ByIdQuery request, CancellationToken cancellationToken = default(CancellationToken))
		{
			return await Send(request, cancellationToken);
		}

		[HttpPost]
		public async Task<ActionResult<Post@(entityName)CommandResponse>> Post(Post@(entityName)Command request, CancellationToken cancellationToken = default(CancellationToken))
		{
			return await Send(request, cancellationToken);
		}

		[HttpPut("{id:@(TypeMapperHelper.Map(Model.Entity.IdType))}")]
		public async Task<ActionResult<Put@(entityName)CommandResponse>> Put(Put@(entityName)Command request, CancellationToken cancellationToken = default(CancellationToken))
		{
			return await Send(request, cancellationToken);
		}

		[HttpPatch("{id:@(TypeMapperHelper.Map(Model.Entity.IdType))}")]
		public async Task<ActionResult<Patch@(entityName)CommandResponse>> Patch(Patch@(entityName)Command request, CancellationToken cancellationToken = default(CancellationToken))
		{
			return await Send(request, cancellationToken);
		}

		[HttpDelete("{id:@(TypeMapperHelper.Map(Model.Entity.IdType))}")]
		public async Task<ActionResult<Delete@(entityName)CommandResponse>> Delete(Delete@(entityName)Command request, CancellationToken cancellationToken = default(CancellationToken))
		{
			return await Send(request, cancellationToken);
		}
    }
}