@using System.Linq
@using BAYSOFT.Abstractions.Crosscutting.Extensions
@using Forge.CLI.Core.Templates
@using Forge.CLI.Shared.Extensions
@using Forge.CLI.Shared.Helpers
@using static Forge.CLI.Shared.Helpers.ForgeHelper
@model TemplateModel
@{
	var projectName = Model.Project.Name;
	var contextName = Model.ContextName;
	var entityName = Model.EntityName;
	var entityCollection = Pluralize(Model.EntityName);

	var projectConvention = GetProjectConvention(Model.Project);

	var queryRelationsManyToOne = Model.Entity.Relations.Where(r => r.Value.Type == "many-to-one").AsQueryable();
	var queryRelationsOneToMany = Model.Entity.Relations.Where(r => r.Value.Type == "one-to-many").AsQueryable();

    var referencedNamespaces = new List<string>()
    {
		UsingInBlazor($"{RenderArtifactNamespace("Application.Command.Delete", Model)}"),
		UsingInBlazor($"{RenderArtifactNamespace("Application.Query.GetByFilter", Model)}"),
		UsingInBlazor($"{RenderArtifactNamespace("Domain.Entity", Model)}"),
		UsingInBlazor($"{RenderArtifactNamespace("Web.Blazor.Filter", Model)}"),
		UsingInBlazor($"{projectConvention}.Presentations.Web.Blazor.Components.Helpers"),
		UsingInBlazor($"{projectConvention}.Presentations.Web.Blazor.Components.Shared"),
		UsingInBlazor($"{projectConvention}.Presentations.Web.Blazor.Components.SmartComponents"),
		UsingInBlazor($"{projectConvention}.Presentations.Web.Blazor.Extensions"),
		UsingInBlazor($"{projectConvention}.Presentations.Web.Blazor.Models"),
		UsingInBlazor("MediatR"),
		UsingInBlazor("Microsoft.Extensions.Localization"),
		UsingInBlazor("ModelWrapper.Extensions.GetModels"),
    };
}
@foreach (var referencedNamespace in referencedNamespaces.Order().Distinct())
{
<text>@(referencedNamespace)
</text>
}

@@inject IDialogService DialogService
@@inject ISnackbar Snackbar
@@inject IServiceScopeFactory scope
@@inject IStringLocalizer<@(entityName)> Localizer

@@inherits TableBase<@(entityName), @(TypeMapperHelper.Map(Model.Entity.IdType))>

<SmartTable 
	@@bind-TableModel="TableModel"
	GetData="@@((state, cancellationToken) => ServerReload(state, cancellationToken))"
	Search="@@(text => OnSearch(text))"
	VisibleRows="VisibleRows">
</SmartTable>

@@code {
@foreach(var relation in queryRelationsManyToOne.ToList())
{
<text>@(Tab(1))[Parameter] public @(TypeMapperHelper.Map(Model.Entity.IdType))? @(relation.Key)Id { get; set; }
</text>
}
	public Table@(entityCollection)() : base()
	{
		Search = string.Empty;
	}
	protected override async Task OnInitializedAsync()
	{
		InitializeConfigurations(Localizer["@(entityCollection)"], "/@(contextName.ToKebabCase())/@(entityCollection.ToKebabCase())");
	}
	protected override void AddColumns()
	{
@foreach(var property in Model.Entity.Properties)
{
<text>@(Tab(2))TableModel.Headers.Add(new("@(property.Key)", Localizer["@(property.Key)"], SortDirection.Ascending));
</text>
}		
	}
	private async Task<TableData<@(entityName)>> ServerReload(TableState state, CancellationToken cancellationToken)
	{
		var query = new Get@(entityCollection)ByFilterQuery();

		query.ApplySearch(Search);

		query.ApplyFilters(@(string.Join(", ", queryRelationsManyToOne.Select(fk => $"{fk.Key}Id").ToList())));

		query.ApplyOrdination(state.SortDirection.ToDescriptionString(), state.SortLabel);

		query.ApplyPagination(state.PageSize, state.Page + 1);

		var response = await scope.SendInNewScope(query, cancellationToken);

		TableModel.SelectedItems = new();

		response.HandleNotifications(Snackbar, false);

		return new() { TotalItems = (int)response.ResultCount, Items = response.GetModels() };
	}
	protected override async Task Delete()
	{
		var parameters = new DialogParameters<Dialog>();
		parameters.Add(x => x.ContentText, Localizer["Do you really want to delete these records? This process cannot be undone."]);
		parameters.Add(x => x.ButtonConfirmText, Localizer["Delete"]);
		parameters.Add(x => x.Color, Color.Error);

		var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall, BackgroundClass = "dialog-backdrop-blur" };

		var dialog = await DialogService.ShowAsync<Dialog>(Localizer["Delete"], parameters, options);
		var result = await dialog.Result;
		if (result != null && !result.Canceled)
		{
			foreach (var selectedItem in TableModel.SelectedItems.ToList())
			{
				var deleteCommand = new Delete@(entityName)Command();
				deleteCommand.Project(m => m.Id = selectedItem.Id);
				var response = await scope.SendInNewScope(deleteCommand);
				if (response.HandleNotifications(Snackbar))
				{
					StateHasChanged();
					await TableModel.MudTable.ReloadServerData();
				}
			}
		}
	}
}