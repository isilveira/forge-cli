@using System.Linq
@using Forge.CLI.Core.Templates
@using Forge.CLI.Shared.Extensions
@using static Forge.CLI.Shared.Helpers.ForgeHelper
@model TemplateModel
@{
	var projectName = Model.Project.Name;
	var contextName = Model.ContextName;
	var entityName = Model.EntityName;
	var entityCollection = Pluralize(Model.EntityName);

    
    
	

	var queryRelationsManyToOne = Model.Entity.Relations.Where(r => r.Value.Type == "many-to-one").AsQueryable();
	var queryRelationsOneToMany = Model.Entity.Relations.Where(r => r.Value.Type == "one-to-many").AsQueryable();

    var referencedNamespaces = new List<string>()
    {
		UsingInCSharp($"{RenderArtifactNamespace("Application.Query.GetByFilter", Model)}"),
		UsingInCSharp("ModelWrapper.Extensions.Filter"),
		UsingInCSharp("ModelWrapper.Extensions.Ordination"),
		UsingInCSharp("ModelWrapper.Extensions.Pagination"),
		UsingInCSharp("ModelWrapper.Extensions.Search")
    };
}
@foreach (var referencedNamespace in referencedNamespaces.Order().Distinct())
{
<text>@(referencedNamespace)
</text>
}

namespace @(Model.Namespace)
{
	public static class @(entityCollection)FilterHelper
	{
		public static void ApplyOrdination(this Get@(entityCollection)ByFilterQuery query, string order, string? orderBy)
		{
			if (!string.IsNullOrWhiteSpace(orderBy))
				query.SetOrdination(order, orderBy);
		}
		public static void ApplyPagination(this Get@(entityCollection)ByFilterQuery query, int pageSize, int pageNumber)
		{
			query.SetPagination(pageSize, pageNumber);
		}
		public static void ApplySearch(this Get@(entityCollection)ByFilterQuery query, string search)
		{
			query.ClearSearch();
			if (!string.IsNullOrWhiteSpace(search))
			{
				query.SetSearch(search);
			}
		}
		public static void ApplyFilters(this Get@(entityCollection)ByFilterQuery query@(queryRelationsManyToOne.Any() ? $", {string.Join(", ", queryRelationsManyToOne.Select(fk => $"{fk.Value.GetTargetIdType()}? {fk.Key.ToCamel()}Id").ToList())}" : ""))
		{
			query.ClearFilters();
@foreach(var relation in queryRelationsManyToOne.ToList())
{
<text>
@(Tab(3))if (@(relation.Key.ToCamel())Id.HasValue)
@(Tab(4))query.AddFilter(nameof(@(relation.Key.ToCamel())Id), @(relation.Key.ToCamel())Id.Value);
</text>
}
		}
	}
}