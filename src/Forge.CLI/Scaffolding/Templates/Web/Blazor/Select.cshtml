@using System.Linq
@using Forge.CLI.Core.Templates
@using Forge.CLI.Shared.Extensions
@using Forge.CLI.Shared.Helpers
@using static Forge.CLI.Shared.Helpers.ForgeHelper
@model TemplateModel
@{
	var projectName = Model.Project.Name;
	var contextName = Model.ContextName;
	var entityName = Model.EntityName;
	var entityCollection = Pluralize(Model.EntityName);
	
	var projectConvention = GetProjectConvention(Model.Project);

	var queryRelationsManyToOne = Model.Entity.Relations.Where(r => r.Value.Type == "many-to-one").AsQueryable();
	var queryRelationsOneToMany = Model.Entity.Relations.Where(r => r.Value.Type == "one-to-many").AsQueryable();

	var selectText = Model.Entity.Properties.Any(p => p.Value.DisplayOnSelect)
		? string.Join(" - ", Model.Entity.Properties.Where(p => p.Value.DisplayOnSelect).Select(p=>$"{{e.{p.Key}}}").ToList())
		: "{e.Id}";

    var referencedNamespaces = new List<string>()
    {
		UsingInBlazor("System.Linq.Expressions"),
		UsingInBlazor($"{RenderArtifactNamespace("Application.Query.GetByFilter", Model)}"),
		UsingInBlazor($"{RenderArtifactNamespace("Domain.Entity", Model)}"),
		UsingInBlazor($"{RenderArtifactNamespace("Web.Blazor.Filter", Model)}"),
		UsingInBlazor($"{projectConvention}.Presentations.Web.Blazor.Components.SmartComponents"),
		UsingInBlazor("Microsoft.Extensions.Localization"),
		UsingInBlazor("ModelWrapper.Extensions.GetModels"),
		UsingInBlazor($"{projectConvention}.Presentations.Web.Blazor.Extensions"),
    };
}
@foreach (var referencedNamespace in referencedNamespaces.Order().Distinct())
{
<text>@(referencedNamespace)
</text>
}

@@inject IServiceScopeFactory scope
@@inject IDialogService DialogService
@@inject ISnackbar Snackbar
@@inject IStringLocalizer<@(entityName)> Localizer

@@if (!Id.HasValue)
{
	<MudItem lg="lg" md="md" sm="sm" xl="xl" xs="xs" xxl="xxl">
		<SmartSelect @@ref="Select" TEntity="@(entityName)" Label="@@Label" Value="Value" ValueChanged="ValueChanged" Search="@@Search" SetDisplay="@@(e=> $"@(selectText)")" AllowAdd="false" OnAdd="Add" AllowEdit="false" OnEdit="Edit" />
	</MudItem>
}

@@code {
	[Parameter] public int lg { get; set; }
	[Parameter] public int md { get; set; }
	[Parameter] public int sm { get; set; }
	[Parameter] public int xl { get; set; }
	[Parameter] public int xs { get; set; }
	[Parameter] public int xxl { get; set; }

	[Parameter] public @(TypeMapperHelper.Map(Model.Entity.IdType))? Id { get; set; }
@foreach(var relation in queryRelationsManyToOne.ToList())
{
<text>@(Tab(1))[Parameter] public @(TypeMapperHelper.Map(Model.Entity.IdType))? @(relation.Key)Id { get; set; }
</text>
}
	[Parameter] public string? Label { get; set; }
	[Parameter] public @(entityName)? Value { get; set; }
	[Parameter] public EventCallback<@(entityName)?> ValueChanged { get; set; }
	[Parameter] public Expression<Func<@(entityName)?>>? ValueExpression { get; set; }
	private SmartSelect<@(entityName)> Select { get; set; }

	private async Task OnValueChanged(@(entityName)? value) => await this.ValueChanged.InvokeAsync(value);

	private async Task<IEnumerable<@(entityName)>> Search(string search, CancellationToken token)
	{
		var query = new Get@(entityCollection)ByFilterQuery();

		var entities = new @(entityName)[] { };

		query.ApplySearch(search);
		
		query.ApplyFilters(@(queryRelationsManyToOne.Any() ? $"{string.Join(", ", queryRelationsManyToOne.Select(fk => $"{fk.Key}Id").ToList())}" : ""));
		
		var response = await scope.SendInNewScope(query);
		if (response != null && response.HandleNotifications(Snackbar, false))
		{
			entities = response.GetModels().ToArray();
		}

		return entities;
	}
	private async Task Add()
	{
		await OpenDialog(null);
	}
	private async Task Edit()
	{
		await OpenDialog(Value != null ? Value.Id : Id);
	}
	private async Task OpenDialog(@(TypeMapperHelper.Map(Model.Entity.IdType))? id)
	{
		var title = "Create {0}";
		var parameters = new DialogParameters<Dialog@(entityName)>();

		if (id.HasValue)
		{
			parameters.Add(x => x.Id, id);
			title = "Edit {0}";
		}

		parameters.Add(x => x.ButtonConfirmText, Localizer["Save"]);
		parameters.Add(x => x.Color, Color.Error);

		var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, BackgroundClass = "dialog-backdrop-blur" };

		var dialog = await DialogService.ShowAsync<Dialog@(entityName)>(string.Format(Localizer["Create new {0}"], Localizer["@(entityName)"].ToString().ToLower()), parameters, options);
		
		var result = await dialog.Result;
		if (result != null! && !result.Canceled && result.Data != null && result.Data is @(entityName) updatedEntity)
		{
			Value = updatedEntity;
			await Select.SelectValue(Value);
		}
	} 
}