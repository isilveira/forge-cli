@using System.Linq
@using Forge.CLI.Core.Templates
@using Forge.CLI.Shared.Extensions
@using static Forge.CLI.Shared.Helpers.ForgeHelper
@model TemplateModel
@{
	var projectName = Model.Project.Name;
	var contextName = Model.ContextName;
	var entityName = Model.EntityName;
	var entityCollection = Pluralize(Model.EntityName);

	var projectConvention = GetProjectConvention(Model.Project);

	var queryRelationsManyToOne = Model.Entity.Relations.Where(r => r.Value.Type == "many-to-one").AsQueryable();
	var queryRelationsOneToMany = Model.Entity.Relations.Where(r => r.Value.Type == "one-to-many").AsQueryable();

    var referencedNamespaces = new List<string>()
	{
		UsingInBlazor($"{RenderArtifactNamespace("Domain.Entity", Model)}"),
		UsingInBlazor($"{projectConvention}.Presentations.Web.Blazor.Components.SmartComponents"),
    };
}
@foreach (var referencedNamespace in referencedNamespaces.Order().Distinct())
{
<text>@@@(referencedNamespace)
</text>
}

@@inject IServiceScopeFactory scope
@@inject NavigationManager Navigation
@@inject ISnackbar Snackbar

<SmartPage TEntity="@(entityName)" TKey="@(Model.Entity.IdType)?" Id="Id" OnGoBack="GoBack">
	<FormContent>
        <Form@(entityName) 
            Id="Id"
@foreach (var relation in queryRelationsManyToOne.ToList())
{
<text>@(Tab(3))@(relation.Key)Id="@(relation.Key)Id"
</text>
}
            OnSaveCallback="SaveCallback">
        </Form@(entityName)>
	</FormContent>
	<TabsContent>
		@@if (ChildContent != null)
		{
			@@ChildContent
		}
	</TabsContent>
</SmartPage>

@@code {
	[Parameter] public @(Model.Entity.IdType)? Id { get; set; }
@foreach(var relation in queryRelationsManyToOne.ToList())
{
<text>@(Tab(1))[Parameter] public @(relation.Value.GetTargetIdType())? @(relation.Key)Id { get; set; }
</text>
}
	[Parameter] public string RootEndPoint { get; set; }
	[Parameter] public RenderFragment? ChildContent { get; set; }
	
	private void GoBack()
	{
		Navigation.NavigateTo(RootEndPoint); return;
	}

	private void SaveCallback(@(entityName) model)
	{
		GoBack();
	}
}