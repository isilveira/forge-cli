@using System.Linq
@using Forge.CLI.Core.Templates
@using Forge.CLI.Shared.Extensions
@using Forge.CLI.Shared.Helpers
@using static Forge.CLI.Shared.Helpers.ForgeHelper
@model TemplateModel
@{
    var projectName = Model.Project.Name;
    var contextName = Model.ContextName;
    var entityName = Model.EntityName;
    var entityCollection = Pluralize(Model.EntityName);

    var queryRelationsManyToOne = Model.Entity.Relations.Where(r => r.Value.Type == "many-to-one").AsQueryable();
    var queryRelationsOneToMany = Model.Entity.Relations.Where(r => r.Value.Type == "one-to-many").AsQueryable();

    var referencedNamespaces = new List<string>()
    {
        UsingInCSharp("Microsoft.EntityFrameworkCore"),
        UsingInCSharp("Microsoft.EntityFrameworkCore.Metadata.Builders"),
        UsingInCSharp("System"),
        UsingInCSharp($"{RenderArtifactNamespace("Domain.Entity", Model)}"),
    };

	var identityTypes = new List<string>() { "int", "long", "short" };
	var useIdentity = identityTypes.Contains(Model.Entity.IdType.ToLower());
}

@foreach (var referencedNamespace in referencedNamespaces.Order().Distinct())
{
<text>@(referencedNamespace)
</text>
}

namespace @(Model.Namespace)
{
    public @(Model.Project.UseSealedClasses ? "sealed ":"")class @(entityName)Map : IEntityTypeConfiguration<@(entityName)>
    {
        public void Configure(EntityTypeBuilder<@(entityName)> builder)
        {
            #region Map Table
            builder
                .ToTable("@(Model.Entity.Table)");
            #endregion

            #region Map Primary Key
            builder
                .Property<@(TypeMapperHelper.Map(Model.Entity.IdType))>(p => p.Id)
                .HasColumnType("@(TypeMapperHelper.DbMap(Model.Entity.IdType))")
                .HasColumnName("Id")
                .ValueGeneratedOnAdd()
@if (useIdentity)
{
<text>@(Tab(4)).UseIdentityColumn()
</text>
}
                .IsRequired(true);

            builder
			    .HasKey(e => e.Id);
			#endregion

            #region Map Properties
@foreach(var property in Model.Entity.Properties)
{
<text>@(Tab(3))builder
@(Tab(4)).Property<@(TypeMapperHelper.Map(property.Value.Type))@(property.Value.Required?"":"?")>(e => e.@(property.Key))
@(Tab(4)).HasColumnType("@(TypeMapperHelper.DbMap(property.Value.Type))@(property.Value.Type == "string" ? $"({(property.Value.HasMaxLength ? "MAX" : property.Value.Length.HasValue ? property.Value.Length : "64")})" : property.Value.Type == "decimal" ? $"({property.Value.Precision}, {property.Value.Scale})" : "")")
@(Tab(4)).HasColumnName("@(property.Key)")
@(Tab(4)).IsRequired(@(property.Value.Required ? "true" : "false"));
</text>
}
            #endregion

            #region Map Foreign Keys
@if (queryRelationsManyToOne.Any())
{
    foreach (var relation in queryRelationsManyToOne.ToList())
    {
<text>@(Tab(3))builder
@(Tab(4)).Property<@(TypeMapperHelper.Map(Model.Entity.IdType))@(relation.Value.Required?"":"?    ")>(e => e.@(relation.Key)Id)
@(Tab(4)).HasColumnType("@(TypeMapperHelper.DbMap(Model.Entity.IdType))")
@(Tab(4)).HasColumnName("@(relation.Key)Id")
@(Tab(4)).IsRequired(@(relation.Value.Required ? "true" : "false"));
</text>
    }
}
else
{
    // No relations to map
}
            #endregion

            #region Map Relations
@if (queryRelationsManyToOne.Any())
{
    foreach (var relation in queryRelationsManyToOne.ToList())
    {
        var targetEntity = Model.Context.Entities.Where(e => e.Key == relation.Value.Target).FirstOrDefault();
        var targetRelation = targetEntity.Value.Relations.Where(r => r.Value.Target == entityName && r.Value.Type == "one-to-many").FirstOrDefault();
<text>@(Tab(3))builder
@(Tab(4)).HasOne(e => e.@(relation.Key))
@(Tab(4)).WithMany(e => e.@(targetRelation.Key))
@(Tab(4)).HasForeignKey(e => e.@(relation.Key)Id)
@(Tab(4)).OnDelete(DeleteBehavior.NoAction);
</text>
    }
}
else
{
    // No relations to map
}
            #endregion
            }
    }
}