@using System.Linq
@using Forge.CLI.Core.Templates
@using Forge.CLI.Shared.Extensions
@using static Forge.CLI.Shared.Helpers.ForgeHelper
@model TemplateModel
@{
    var projectName = Model.Project.Name;
    var contextName = Model.ContextName;

    var referencedNamespaces = new List<string>()
    {
        UsingInCSharp("BAYSOFT.Abstractions.Core.Domain.Interfaces.Infrastructures.Data"),
        UsingInCSharp($"{RenderArtifactNamespace("Infrastructure.Mapping", Model)}"),
        UsingInCSharp("Microsoft.EntityFrameworkCore"),
    };
    foreach(var e in Model.Context.Entities)
    {
        referencedNamespaces.Add(UsingInCSharp($"{RenderArtifactNamespace("Domain.Entity", Model, targetEntity: e.Key)}"));
    }
}

@foreach (var referencedNamespace in referencedNamespaces.Order().Distinct())
{
<text>@(referencedNamespace)
</text>
}

namespace @(Model.Namespace)
{
    public @(Model.Project.UseSealedClasses ? "sealed ":"")class @(contextName)DbContext : DbContext
    {
        public static string Schema => "@(Model.Context.Schema)";

@foreach(var e in Model.Context.Entities)
{
<text>        public DbSet<@e.Key> @Pluralize(e.Key) { get; set; }
</text>
}
        public @(contextName)DbContext() { }
        public @(contextName)DbContext(DbContextOptions<@(contextName)DbContext> options) : base(options){ }
        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            modelBuilder.HasDefaultSchema(Schema);

@foreach (var e in Model.Context.Entities)
{
<text>            modelBuilder.ApplyConfiguration(new @(e.Key)Map());
</text>
}
        }
    }
}